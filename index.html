<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link href="./bootstrap.css" rel="stylesheet">
	<link href="./phraseseditor.css" rel="stylesheet">
	<title>Phrases editor</title>
</head>
<body>
	<div id="renderArea">

	</div>
	<nav class="navbar navbar-default navbar-fixed-bottom">

		<div class="navbar-header">
			<a class="navbar-brand" href="#" onclick="return false;" style="color:#990ae3;">Phrases editor</a>
		</div>
		<ul class="nav navbar-nav">
			<li><a id="loadData" href="#">Open</a></li>
			<li><a id="reloadData" href="#">Reload</a></li>
			<li><a id="saveData" href="#">Save</a></li>
			<li><a id="createNew" href="#">Create new</a></li>
		</ul>
		<form class="navbar-form navbar-right" role="search">
			<div class="form-group">
				<input type="text" class="form-control search" placeholder="Search">
			</div>
		</form>
	</nav>
</body>

<script>
	window.$ = window.jQuery = require('./jquery-2.2.4.min.js');
	const ui = require('./ui/table-ui.js');
	const dataStorage = require('./file_io/datastorage.js');
	const settingsHandler = require('./settings/settings-handler.js');

	dataStorage.getPhrasesData().addChangeListener(() => {
		ui.updateTitle();
	});

	$('#loadData').click(function(event) {
		event.stopPropagation();
		let dialog = require('electron').remote.dialog;
		let fileNames = dialog.showOpenDialog({properties: ['openDirectory']});
		if(fileNames && fileNames.length) {
			loadDirectory(fileNames[0]);
			settingsHandler.update({lastOpenDirectory : fileNames[0]}, 'user');
		};
	});

	$('#saveData').click(function(event) {
		event.stopPropagation();
		if(dataStorage.isDirty()) {
			dataStorage.save();
			ui.renderData();
		}
	});

	$('#reloadData').click(function(event) {
		event.stopPropagation();
		dataStorage.load();
		$('button').prop("disabled", false);
		ui.renderData();
	});

	$('#createNew').click(function(event) {
		event.stopPropagation();
		ui.addRow();
	});

	let searchTimerId;
	$('input.search').keyup(function() {
		clearTimeout(searchTimerId);
		searchTimerId = window.setTimeout(ui.filterForSearch, 300);
	});

	settingsHandler.get().then(settings => {
		if(settings.lastOpenDirectory) {
			loadDirectory(settings.lastOpenDirectory);
		}
	});

	function loadDirectory(directory) {
		$('#renderArea').html('<div class="container"><p>Loading phrases from ' + directory + '</p></div>');
		dataStorage.load(directory);
		$('button').prop("disabled", false);
		ui.renderData();
	}

</script>
</html>
